# Stream Configuration for HTTPS Pass-through
# This handles TCP/TLS connections on port 443 and forwards them to Traefik

stream {
    # Logging for stream connections
    error_log /var/log/nginx/stream_error.log warn;
    access_log /var/log/nginx/stream_access.log;

    # Upstream for HTTPS pass-through
    upstream homelab_ssl {
        server ${HOMELAB_IP}:443 max_fails=3 fail_timeout=30s;
        
        # Optional: Add backup server
        # server backup-ip:443 backup;
    }

    # Map to detect SSL/TLS traffic
    map $ssl_preread_server_name $backend_pool {
        wielandtech.com homelab_ssl;
        www.wielandtech.com homelab_ssl;
        default homelab_ssl;
    }

    # HTTPS Pass-through Server
    server {
        listen 443;
        proxy_pass $backend_pool;
        
        # SSL preread to get SNI
        ssl_preread on;
        
        # Proxy settings
        proxy_timeout 1s;
        proxy_connect_timeout 1s;
        proxy_responses 1;
        
        # Buffer settings
        proxy_buffer_size 4k;
        
        # Enable proxy protocol if needed
        # proxy_protocol on;
    }
}
